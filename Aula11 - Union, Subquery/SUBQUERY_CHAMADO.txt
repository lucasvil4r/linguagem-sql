
--EXEMPLO DE SUBQUERY NO SELECT, GERALMENTE USADO PARA CALCULAR METRICAS - O IDEAL É NÃO UTILIZAR, PARA CADA LINHA ELE FAZ UMA QUERY

--SOMANDO TODOS OS CUSTOS POR ATENDENTE
SELECT *, 
(SELECT SUM(CUSTO) CUSTO FROM [dbo].[CHAMADO] WHERE ID_ATENDENTE = func.ID_FUNCIONARIO) subquery
FROM [dbo].[FUNCIONARIO] func


--BUSCANDO A ULTIMA DATA DE ABERTURA POR DEPARTAMENTO 
SELECT NOME,	
	(SELECT MAX(ABERTURA)  FROM [dbo].[CHAMADO]  C INNER JOIN 
						[dbo].[FUNCIONARIO] f ON ID_SOLICITANTE = F.ID_FUNCIONARIO
						WHERE F.ID_DEPARTAMENTO = D.ID_DEPARTAMENTO) ULTIMO_CHAMADO_ABERTO
FROM DEPARTAMENTO D


--EXEMPLO DE SUBQUERY NO FROM --MUITO UTILIZADO

--AGRUPANDO CUSTOS NA SUBQUERY E DEPOIS UM RANK POR FUNCIONARIOS COM MAIS CUSTO
SELECT FUNCIONARIO,CUSTO, RANK() OVER(ORDER BY CUSTO DESC) RANKING

FROM 
(
SELECT F.NOME FUNCIONARIO,SUM(CUSTO) CUSTO
FROM [dbo].[CHAMADO]  C INNER JOIN 
[dbo].[FUNCIONARIO] f ON ID_ATENDENTE = F.ID_FUNCIONARIO
GROUP BY F.NOME
)  T

SELECT ID_CHAMADO, HORAS FROM (
SELECT [ID_CHAMADO],DATEDIFF(HOUR,[ABERTURA],FECHAMENTO) HORAS
FROM [dbo].[CHAMADO] 
) H
WHERE H.HORAS > 0


--EXEMPLO DE SUBQUERY NO WHERE --MUITO UTILIZADO PARA FILTRAGENS DE UMA TABELA PARA OUTRA
SELECT * FROM [dbo].[FUNCIONARIO] WHERE ID_FUNCIONARIO IN (SELECT ID_SOLICITANTE FROM CHAMADO WHERE FECHAMENTO IS NOT NULL)

SELECT * FROM [dbo].[DEPARTAMENTO] WHERE ID_DEPARTAMENTO IN ( SELECT ID_DEPARTAMENTO
																FROM [dbo].[CHAMADO]  C INNER JOIN 
																[dbo].[FUNCIONARIO] f ON ID_SOLICITANTE = F.ID_FUNCIONARIO)

SELECT * FROM [dbo].[PRIORIDADE] WHERE ID_PRIORIDADE IN (SELECT ID_PRIORIDADE FROM CHAMADO WHERE FECHAMENTO IS NOT NULL)